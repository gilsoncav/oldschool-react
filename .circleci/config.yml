version: 2.1
orbs:
  node: circleci/node@1.1.6
  docker: circleci/docker@0.5.13
  gcp-cli: circleci/gcp-cli@1.8.2
  kubernetes: circleci/kubernetes@0.7.0
  codecov: codecov/codecov@1.0.5

jobs:
  test:
    description: Test SPA
    machine: true
    steps:
      - checkout
      - node/install
      - node/install-yarn
      - node/with-cache:
          steps:
            - run:
                name: Install application dependencies
                command: yarn
          cache-key: package.json
          use-strict-cache: true
      - run:
          name: Test
          command: yarn test --coverage --collectCoverageFrom=src/**/*.js --collectCoverageFrom=!src/**/*.stories.js --collectCoverageFrom=!src/utils/* --collectCoverageFrom=!src/service/* --maxWorkers=2
      - store_artifacts:
          path: coverage
      - codecov/upload:
          file: ./coverage/coverage-final.json
  build-push-docker:
    description: Build and push image to Docker Hub
    machine: true
    steps:
      - checkout
      - docker/check
      - docker/build:
          image: $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
          tag: test-$CIRCLE_SHA1
      - run:
          name: Tag Image as Latest
          command: docker tag $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:test-$CIRCLE_SHA1 $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:latest
      - docker/push:
          image: $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
          tag: test-$CIRCLE_SHA1
      - docker/push:
          image: $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
          tag: latest
  deploy:
    description: Deploy application to Google Kubernetes Engine
    machine: true
    steps:
      - gcp-cli/install
      - kubernetes/install
      - gcp-cli/initialize
      - run:
          name: Set Cloud Region
          command: gcloud container clusters get-credentials --region=$GOOGLE_COMPUTE_REGION kates-cluster
      - run:
          name: Deploy New Image Version
          command: kubectl set image deployment/test-oldschool-react oldschool-react=$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:test-$CIRCLE_SHA1
workflows:
  test_build_update_deploy:
    jobs:
      - test
      - build-push-docker:
          requires:
            - test
      - deploy:
          requires:
            - build-push-docker
